<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WXWI Disruption Thermostat</title>
  <style>
    :root{
      --bg0:#040611;
      --bg1:#070a19;
      --panel:#0b1028cc;
      --stroke:#1b2a55;
      --text:#e9f2ff;
      --muted:#a9b7d6;
      --wizzMagenta:#ff2ea6;
      --wizzPurple:#7b2cff;
      --cyan:#3ef6ff;
      --amber:#ffb020;
      --good:#52ffb7;
      --bad:#ff355b;

      --modeColor: var(--wizzMagenta);
      --modeGlow: rgba(255,46,166,.22);
      --radius: 26px;

      /* TV-readable scale */
      --fzBase: clamp(18px, 1.15vw, 34px);
      --fzH1: clamp(28px, 2.1vw, 56px);
      --fzH2: clamp(22px, 1.6vw, 44px);
      --fzBig: clamp(160px, 10.8vw, 360px);
      --fzNum: clamp(56px, 3.4vw, 120px);
      --fzIata: clamp(20px, 1.55vw, 44px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background: radial-gradient(1100px 900px at 12% 18%, rgba(255,46,166,.18), transparent 60%),
                                 radial-gradient(1000px 900px at 88% 22%, rgba(62,246,255,.12), transparent 60%),
                                 radial-gradient(900px 800px at 55% 85%, rgba(123,44,255,.12), transparent 60%),
                                 linear-gradient(180deg, var(--bg1), var(--bg0) 62%, #02030a);
              color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    .wrap{
      height:100vh;
      padding: clamp(18px, 1.6vw, 52px);
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap: clamp(14px, 1.2vw, 28px);
      overflow:hidden;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: clamp(12px, 1.0vw, 22px) clamp(16px, 1.4vw, 30px);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(10,14,35,.72), rgba(6,8,22,.52));
      border: 1px solid rgba(62,246,255,.16);
      box-shadow: 0 0 0 1px rgba(255,46,166,.08) inset, 0 22px 60px rgba(0,0,0,.55);
      position:relative;
    }
    .topbar:before{
      content:""; position:absolute; inset:-2px; border-radius: calc(var(--radius) + 2px);
      pointer-events:none;
      box-shadow: 0 0 34px rgba(255,46,166,.12), 0 0 38px rgba(62,246,255,.08);
    }

    .brand{ display:flex; align-items:center; gap: clamp(10px, 1.0vw, 18px); min-width:0; }
    .brand img{ height: clamp(22px, 2.0vw, 44px); filter: drop-shadow(0 0 10px rgba(255,46,166,.35)); }
    .title{ font-weight: 900; letter-spacing:.18em; text-transform:uppercase; font-size: var(--fzH1); white-space:nowrap; }
    .pills{ display:flex; align-items:center; gap: clamp(8px, .8vw, 14px); flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      font-size: clamp(14px, .95vw, 24px);
      letter-spacing:.14em; text-transform:uppercase; font-weight:800;
      padding: clamp(6px, .55vw, 12px) clamp(10px, .85vw, 18px);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,14,30,.55);
      box-shadow: 0 0 0 1px rgba(0,0,0,.4) inset;
      white-space:nowrap;
    }
    .pill.mode{
      border-color: rgba(255,46,166,.35);
      box-shadow: 0 0 24px var(--modeGlow), 0 0 0 1px rgba(0,0,0,.35) inset;
      color: var(--modeColor);
    }
    .pill.data.ok{ border-color: rgba(82,255,183,.35); color: var(--good); }
    .pill.data.bad{ border-color: rgba(255,53,91,.35); color: var(--bad); box-shadow:0 0 24px rgba(255,53,91,.14); }

    .content{
      display:grid;
      place-items:center;
      padding: clamp(6px, .6vw, 12px);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(9,12,28,.62), rgba(4,5,16,.35));
      border: 1px solid rgba(62,246,255,.14);
      position:relative;
      overflow:hidden;
    }
    .content:after{
      content:""; position:absolute; inset:0;
      background: radial-gradient(900px 700px at 50% 55%, rgba(255,46,166,.08), transparent 64%),
                  radial-gradient(900px 700px at 50% 55%, rgba(62,246,255,.06), transparent 70%);
      pointer-events:none;
    }

    /* neon corner brackets (thin L-shapes – no "square" blocks) */
    .bracket{
      position:absolute;
      width:56px; height:56px;
      border-radius: 0;
      pointer-events:none;
      opacity:.85;
      filter: drop-shadow(0 0 14px var(--modeGlow));
    }
    .bracket.tl{
      top:14px; left:14px;
      background:
        linear-gradient(to right, rgba(255,255,255,.22), rgba(255,255,255,.08)) 0 0 / 56px 2px no-repeat,
        linear-gradient(to bottom, rgba(255,255,255,.22), rgba(255,255,255,.08)) 0 0 / 2px 56px no-repeat;
    }
    .bracket.tr{
      top:14px; right:14px;
      background:
        linear-gradient(to left, rgba(255,255,255,.22), rgba(255,255,255,.08)) 100% 0 / 56px 2px no-repeat,
        linear-gradient(to bottom, rgba(255,255,255,.22), rgba(255,255,255,.08)) 100% 0 / 2px 56px no-repeat;
    }
    .bracket.bl{
      bottom:14px; left:14px;
      background:
        linear-gradient(to right, rgba(255,255,255,.22), rgba(255,255,255,.08)) 0 100% / 56px 2px no-repeat,
        linear-gradient(to top, rgba(255,255,255,.22), rgba(255,255,255,.08)) 0 100% / 2px 56px no-repeat;
    }
    .bracket.br{
      bottom:14px; right:14px;
      background:
        linear-gradient(to left, rgba(255,255,255,.22), rgba(255,255,255,.08)) 100% 100% / 56px 2px no-repeat,
        linear-gradient(to top, rgba(255,255,255,.22), rgba(255,255,255,.08)) 100% 100% / 2px 56px no-repeat;
    }

    /*
      IMPORTANT (TV): make the dial ALWAYS fully visible.
      Previously width was tied to 78vh, which could exceed the middle panel height,
      and the dial got clipped by overflow:hidden.
      Here we size the dial from the AVAILABLE HEIGHT of the center panel.
    */
    .gaugeWrap{
      position:relative; z-index:2;
      height: 100%;
      width: auto;
      max-width: 100%;
      aspect-ratio: 1 / 1;
      display:grid;
      place-items:center;
    }
    svg{ width:100%; height:100%; }
    .ringBg{ stroke: rgba(255,255,255,.10); stroke-width: 16; fill: none; }
    .ringGlow{ filter: drop-shadow(0 0 18px var(--modeGlow)); }
    .ringFg{ stroke: var(--modeColor); stroke-width: 20; stroke-linecap: round; fill:none; }
    .center{
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center;
      padding: 8%;
    }
    .nsiVal{
      font-size: var(--fzBig);
      font-weight: 950;
      line-height: .92;
      letter-spacing: -.02em;
      text-shadow: 0 0 36px rgba(0,0,0,.6), 0 0 26px var(--modeGlow);
    }
    .modeTxt{
      margin-top: clamp(6px, .7vw, 14px);
      font-size: clamp(22px, 1.55vw, 44px);
      letter-spacing:.28em;
      text-transform:uppercase;
      font-weight: 900;
      color: var(--modeColor);
      text-shadow: 0 0 18px var(--modeGlow);
    }
    .sub{
      margin-top: clamp(6px, .7vw, 14px);
      font-size: var(--fzBase);
      color: var(--muted);
      letter-spacing:.06em;
    }

    .footer{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: clamp(14px, 1.2vw, 28px);
      align-items:stretch;
      height: clamp(320px, 34vh, 860px);
    }
    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(10,14,35,.70), rgba(5,7,20,.50));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 0 0 1px rgba(62,246,255,.06) inset, 0 18px 54px rgba(0,0,0,.55);
      padding: clamp(16px, 1.3vw, 28px);
      position:relative;
      overflow:hidden;
      min-height: 0;
      height: 100%;
      display:flex;
      flex-direction:column;
      gap: clamp(10px, .9vw, 18px);
    }
    .card:before{
      content:""; position:absolute; inset:-2px; border-radius: calc(var(--radius) + 2px);
      box-shadow: 0 0 30px rgba(62,246,255,.10), 0 0 34px rgba(255,46,166,.08);
      pointer-events:none;
    }

    .cardHead{ display:flex; align-items:baseline; justify-content:space-between; gap: 16px; z-index:1; }
    .cardTitle{
      font-size: var(--fzH2);
      font-weight: 900;
      letter-spacing:.20em;
      text-transform:uppercase;
      display:flex; align-items:center; gap: 10px;
      white-space:nowrap;
    }
    .icon{
      width: clamp(18px, 1.2vw, 30px);
      height: clamp(18px, 1.2vw, 30px);
      filter: drop-shadow(0 0 10px rgba(62,246,255,.20));
      opacity:.95;
    }
    .count{
      font-size: var(--fzNum);
      font-weight: 950;
      letter-spacing:-.01em;
      color: var(--modeColor);
      text-shadow: 0 0 18px var(--modeGlow);
      white-space:nowrap;
    }
    .count.neutral{ color: #cfe6ff; text-shadow: 0 0 12px rgba(62,246,255,.12); }

    .why{
      z-index:1;
      font-size: var(--fzBase);
      color: var(--muted);
      letter-spacing:.04em;
      line-height: 1.25;
      min-height: 0;
    }
    .why b{ color: var(--text); }
    .why ul{ margin: 0; padding-left: 1.2em; }
    .why li{ margin: .25em 0; }

    .iataGrid{
      z-index:1;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: clamp(8px, .7vw, 14px) clamp(18px, 1.2vw, 30px);
      align-content:start;
      min-height: 0;
      flex: 1;
      overflow:hidden;
      padding-top: 2px;
    }
    .iata{
      font-size: var(--fzIata);
      font-weight: 900;
      letter-spacing:.18em;
      text-transform:uppercase;
      white-space:nowrap;
      line-height: 1.05;
    }
    .iata.base{
      color: var(--wizzMagenta);
      text-shadow: 0 0 14px rgba(255,46,166,.28);
    }
    .iata.out{
      color: #dfeaff;
      text-shadow: 0 0 12px rgba(62,246,255,.12);
    }
    .more{
      font-size: clamp(14px, .9vw, 22px);
      color: var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    /* Keep footer safely inside view */
    @media (max-height: 900px){
      :root{ --fzBig: clamp(110px, 10vw, 220px); }
    }
  </style>
</head>
<body>
  <div class="wrap" id="root" style="--modeColor: var(--wizzMagenta); --modeGlow: rgba(255,46,166,.22);">
    <div class="topbar">
      <div class="brand">
        <img src="/assets/brand/wizzair-logo.png" alt="Wizz Air" onerror="this.style.display='none'"/>
        <div class="title">DISRUPTION THERMOSTAT</div>
        <div class="pill mode" id="modePill">PUSH</div>
      </div>
      <div class="pills">
        <div class="pill" id="tsPill">TS: —</div>
        <div class="pill data ok" id="dataPill">DATA: —</div>
        <div class="pill">Generated: <span id="genAt">—</span> UTC</div>
      </div>
    </div>

    <div class="content">
      <div class="bracket tl"></div><div class="bracket tr"></div><div class="bracket bl"></div><div class="bracket br"></div>

      <div class="gaugeWrap">
        <svg viewBox="0 0 200 200" aria-hidden="true">
          <circle class="ringBg" cx="100" cy="100" r="86"></circle>
          <circle class="ringFg ringGlow" id="ring" cx="100" cy="100" r="86" transform="rotate(-90 100 100)"></circle>
        </svg>
        <div class="center">
          <div class="nsiVal" id="nsi">—</div>
          <div class="modeTxt" id="modeTxt">—</div>
          <div class="sub" id="trend">Trend: —</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="card" id="basesCard">
        <div class="cardHead">
          <div class="cardTitle">
            <!-- airport/base icon -->
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 20h18" stroke="currentColor" stroke-width="2" opacity=".9"/><path d="M12 3l8 8-8 2-8-2 8-8Z" stroke="currentColor" stroke-width="2"/><path d="M6 13v5m12-5v5" stroke="currentColor" stroke-width="2" opacity=".8"/></svg>
            BASES IMPACTED
          </div>
          <div class="count" id="basesCount">—</div>
        </div>
        <div class="why">
          <b>Only base-related alerts are shown.</b><br/>
          NOW/FORECAST triggers are merged (any trigger).
        </div>
        <div class="iataGrid" id="basesGrid"></div>
        <div class="more" id="basesMore"></div>
      </div>

      <div class="card" id="iceCard">
        <div class="cardHead">
          <div class="cardTitle">
            <!-- snowflake / engine ice icon -->
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 2v20" stroke="currentColor" stroke-width="2" opacity=".9"/><path d="M4 7l16 10" stroke="currentColor" stroke-width="2" opacity=".8"/><path d="M20 7L4 17" stroke="currentColor" stroke-width="2" opacity=".8"/><path d="M7 4l2 3M15 4l-2 3M7 20l2-3M15 20l-2-3" stroke="currentColor" stroke-width="2" opacity=".7"/></svg>
            ENG ICE OPS
          </div>
          <div class="count neutral" id="iceCount">—</div>
        </div>
        <div class="why" id="iceWhy">
          Always shown (even if zero). Highlights bases in magenta.
        </div>
        <div class="iataGrid" id="iceGrid"></div>
        <div class="more" id="iceMore"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setMode(mode, nsi){
      const m = String(mode || "PUSH").toUpperCase();
      const v = Number.isFinite(Number(nsi)) ? Number(nsi) : 0;

      const root = $("root");
      const pill = $("modePill");
      const modeTxt = $("modeTxt");

      const colors = {
        PUSH:      { c: getComputedStyle(document.documentElement).getPropertyValue("--cyan").trim(),   g: "rgba(62,246,255,.22)" },
        STABILIZE: { c: getComputedStyle(document.documentElement).getPropertyValue("--amber").trim(),  g: "rgba(255,176,32,.18)" },
        PROTECT:   { c: getComputedStyle(document.documentElement).getPropertyValue("--wizzMagenta").trim(), g: "rgba(255,46,166,.22)" },
      };
      const cfg = colors[m] || colors.PUSH;

      root.style.setProperty("--modeColor", cfg.c);
      root.style.setProperty("--modeGlow", cfg.g);

      pill.textContent = m;
      modeTxt.textContent = m;

      // ring stroke
      const ring = $("ring");
      const r = 86;
      const circumference = 2 * Math.PI * r;
      ring.style.strokeDasharray = `${circumference}`;
      const pct = Math.max(0, Math.min(100, v));
      const offset = circumference * (1 - pct / 100);
      ring.style.strokeDashoffset = `${offset}`;
    }

    function clearNode(el){ while(el.firstChild) el.removeChild(el.firstChild); }

    function renderIataGrid(gridEl, moreEl, codes, baseSet, opts={}){
      const all = Array.isArray(codes) ? codes.slice() : [];
      const maxStart = opts.maxStart || 18;
      const step = opts.step || 2;

      let max = Math.min(maxStart, all.length);
      let shown = all.slice(0, max);

      const paint = (arr, remaining) => {
        clearNode(gridEl);
        for(const code of arr){
          const span = document.createElement("div");
          const isBase = baseSet && baseSet.has(code);
          span.className = "iata " + (isBase ? "base" : (opts.forceBase ? "base" : "out"));
          span.textContent = code;
          gridEl.appendChild(span);
        }
        moreEl.textContent = remaining > 0 ? `+${remaining} more` : "";
      };

      // initial
      paint(shown, all.length - shown.length);

      // shrink until fits
      for(let i=0; i<50; i++){
        if(gridEl.scrollHeight <= gridEl.clientHeight + 1) break;
        max = Math.max(0, max - step);
        shown = all.slice(0, max);
        paint(shown, all.length - shown.length);
        if(max === 0) break;
      }
    }

    function toBaseSetFromThermo(d){
      // Prefer explicit lists if present; fallback: read base.txt? (not needed here)
      const s = new Set();
      const basesAny = (d.lists && d.lists.basesAny) ? d.lists.basesAny : [];
      for(const x of basesAny) s.add(String(x).toUpperCase());
      return s;
    }

    async function load(){
      try{
        window.__RENDER_READY__ = false;

        const r = await fetch(`/data/thermostat.json?ts=${Date.now()}`, { cache: "no-store" });
        if(!r.ok) throw new Error(`thermostat.json HTTP ${r.status}`);
        const d = await r.json();

        const genAt = (d.generatedAt || "—");
        $("genAt").textContent = String(genAt).replace("Z","");
        $("tsPill").textContent = `TS: ${String(genAt).slice(0,19)}Z`;

        const nsi = (d.nsi ?? 0);
        $("nsi").textContent = (nsi === 0 || nsi) ? nsi : "—";
        setMode(d.mode || "PUSH", Number(nsi||0));

        const tr = d.trend || {};
        const deltaStr = (typeof tr.delta === "number") ? ` (${tr.delta>0?"+":""}${tr.delta})` : "";
        $("trend").textContent = `Trend: ${tr.direction || "flat"}${deltaStr}`;

        const c = d.counts || {};
        const stations = (typeof c.watchlistAirports === "number") ? c.watchlistAirports : null;
        const met = (typeof c.metarReturned === "number") ? c.metarReturned : null;
        const taf = (typeof c.tafReturned === "number") ? c.tafReturned : null;
        const ok = (stations && stations > 0);

        const dp = $("dataPill");
        dp.textContent = ok ? `DATA: OK (${stations})` : `DATA: MISSING`;
        dp.classList.remove("ok","bad");
        dp.classList.add(ok ? "ok" : "bad");
        if(!ok && (d.errors && d.errors.length)){
          dp.textContent = `DATA: ERROR`;
        }

        // Lists
        const baseSet = new Set((Array.isArray(d.lists?.basesAny) ? d.lists.basesAny : []).map(x => String(x).toUpperCase()));
        const basesAny = Array.isArray(d.lists?.basesAny) ? d.lists.basesAny.map(x => String(x).toUpperCase()) : [];
        const iceAny   = Array.isArray(d.lists?.engIceOps) ? d.lists.engIceOps.map(x => String(x).toUpperCase()) : [];

        $("basesCount").textContent = basesAny.length;
        $("iceCount").textContent = iceAny.length;

        // Render grids: bases force magenta; ice highlight bases
        renderIataGrid($("basesGrid"), $("basesMore"), basesAny, baseSet, { maxStart: 20, forceBase: true });
        renderIataGrid($("iceGrid"), $("iceMore"), iceAny, baseSet, { maxStart: 20, forceBase: false });

        // If you want a simple reason line, keep it minimal
        const iceWhy = $("iceWhy");
        if(iceAny.length === 0){
          iceWhy.textContent = "No ENG ICE OPS alerts.";
        }else{
          iceWhy.textContent = "ENG ICE OPS active at the following stations:";
        }

        window.__RENDER_READY__ = true;
      }catch(e){
        // Make failure obvious on the render (so you can spot pipeline breaks instantly)
        $("dataPill").textContent = "DATA: ERROR";
        $("dataPill").classList.remove("ok"); $("dataPill").classList.add("bad");
        $("trend").textContent = `Error: ${String(e && e.message ? e.message : e).slice(0,120)}`;
        $("basesCount").textContent = "—";
        $("iceCount").textContent = "—";
        window.__RENDER_READY__ = true;
      }
    }

    load();
  </script>
</body>
</html>
