<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>WXWI TV Infographic</title>
  <style>

    :root{
      --bg:#02030a;
      --panel:#071026;
      --stroke: rgba(0, 255, 255, 0.42);
      --stroke2: rgba(0, 255, 255, 0.25);
      --txt: rgba(235, 255, 255, 0.95);
      --muted: rgba(180, 220, 220, 0.75);
      --ok: rgba(0, 255, 200, 0.85);
      --warn: rgba(255, 210, 80, 0.95);
      --bad: rgba(255, 80, 120, 0.95);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{box-sizing:border-box;width:100vw;height:100vh;padding:3vw;display:flex;flex-direction:column;gap:2vw;}
    .hdr{display:flex;justify-content:space-between;align-items:flex-end;gap:2vw;}
    .brand{
      font-weight:800; letter-spacing:0.12em; text-transform:uppercase;
      font-size: clamp(28px, 2.2vw, 78px);
      text-shadow: 0 0 20px rgba(0,255,255,0.18);
    }
    .stamp{
      font-size: clamp(14px, 0.9vw, 28px);
      color: var(--muted);
      text-align:right;
      line-height:1.2;
    }
    .grid{flex:1;display:grid;grid-template-columns:1.2fr 1fr;gap:2vw;min-height:0;}
    .col{display:flex;flex-direction:column;gap:2vw;min-height:0;}
    .card{
      background:linear-gradient(180deg, rgba(7,16,38,0.92), rgba(7,16,38,0.72));
      border:2px solid var(--stroke2);
      border-radius:22px;
      box-shadow: 0 0 0 1px rgba(0,255,255,0.10), 0 0 28px rgba(0,255,255,0.08);
      padding:1.6vw;
      position:relative;
      overflow:hidden;
      min-height:0;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      border:2px solid var(--stroke);
      border-radius:24px;
      filter: drop-shadow(0 0 14px rgba(0,255,255,0.18));
      pointer-events:none;
      opacity:0.45;
    }
    .titleRow{display:flex;align-items:baseline;justify-content:space-between;gap:1.2vw;margin-bottom:1.1vw;}
    .cardTitle{
      font-size: clamp(20px, 1.35vw, 52px);
      font-weight:800; letter-spacing:0.08em; text-transform:uppercase;
      color: rgba(220,255,255,0.98);
    }
    .badge{
      font-size: clamp(12px, 0.85vw, 26px);
      padding:0.35em 0.7em;
      border-radius:999px;
      border:1px solid rgba(0,255,255,0.35);
      color: rgba(210,255,255,0.9);
    }
    .kpis{display:grid;grid-template-columns:repeat(2, 1fr);gap:1.4vw;}
    .kpi{
      min-height:0;
      border-radius: 14px;
      border:1px solid rgba(143,123,255,.22);
      background: linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.12));
      padding:1.0vw 1.05vw;
      position:relative;
      display:flex; flex-direction:column; gap:.48vw;
      box-shadow: inset 0 0 22px rgba(143,123,255,.10), 0 0 18px rgba(62,246,255,.08);
      overflow:hidden; /* keep tidy */
    }
    .kpi:before{
      content:"";
      position:absolute; inset:0;
      border-radius: 14px;
      pointer-events:none;
      border:1px solid rgba(62,246,255,.16);
      box-shadow: 0 0 18px rgba(62,246,255,.10), 0 0 18px rgba(198,0,126,.08);
      opacity:.55;
    }
    .kpiName{font-size: clamp(12px, 0.85vw, 26px);color:var(--muted);letter-spacing:0.06em;text-transform:uppercase;}
    .kpiVal{margin-top:0.4vw;font-size: clamp(18px, 1.25vw, 46px);font-weight:800;}
    .kpiSub{margin-top:0.35vw;font-size: clamp(12px, 0.75vw, 22px);color:var(--muted);line-height:1.25;}
    .list{margin-top:1.2vw;font-size: clamp(12px, 0.8vw, 24px);color:var(--muted);line-height:1.35;}
    .list b{color:rgba(235,255,255,0.95);}
    .two{display:grid;grid-template-columns:1fr;gap:2vw;}
    .smallTitle{font-size: clamp(18px, 1.2vw, 44px);font-weight:800;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:1vw;}
    .row{display:flex;justify-content:space-between;gap:1vw;align-items:baseline;}
    .row .lbl{color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;font-size: clamp(12px, 0.75vw, 22px);}
    .row .val{font-weight:800;font-size: clamp(16px, 1.05vw, 38px);}
    .sep{height:1px;background:rgba(0,255,255,0.15);margin:0.9vw 0;}
    .foot{color:rgba(150,200,200,0.65);font-size: clamp(10px, 0.7vw, 20px);letter-spacing:0.05em;}
  
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">WXWI OPERATIONAL WEATHER – TV BRIEF</div>
      <div class="stamp" id="stamp">Loading…</div>
    </div>

    <div class="grid">
      <div class="col">
        <div class="card">
          <div class="titleRow">
            <div class="cardTitle">Current (METAR)</div>
            <div class="badge" id="nowBadge">NOW</div>
          </div>
          <div class="kpis">
            <div class="kpi">
              <div class="kpiName">Critical</div>
              <div class="kpiVal" id="nowCrit">–</div>
              <div class="kpiSub" id="nowCritEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">High</div>
              <div class="kpiVal" id="nowHigh">–</div>
              <div class="kpiSub" id="nowHighEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Medium</div>
              <div class="kpiVal" id="nowMed">–</div>
              <div class="kpiSub" id="nowMedEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Affected Bases</div>
              <div class="kpiVal" id="nowBases">–</div>
              <div class="kpiSub" id="nowBasesEx">Bases: –</div>
            </div>
          </div>
          <div class="list" id="nowNotes">
            <b>Drivers:</b> visibility/RVR, low cloud base, wind/gusts, snow/contamination (from current triggers).
          </div>
        </div>

        <div class="card">
          <div class="titleRow">
            <div class="cardTitle">Forecast (TAF)</div>
            <div class="badge" id="tafBadge">FORECAST</div>
          </div>
          <div class="kpis">
            <div class="kpi">
              <div class="kpiName">Critical</div>
              <div class="kpiVal" id="tafCrit">–</div>
              <div class="kpiSub" id="tafCritEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">High</div>
              <div class="kpiVal" id="tafHigh">–</div>
              <div class="kpiSub" id="tafHighEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Medium</div>
              <div class="kpiVal" id="tafMed">–</div>
              <div class="kpiSub" id="tafMedEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Affected Bases</div>
              <div class="kpiVal" id="tafBases">–</div>
              <div class="kpiSub" id="tafBasesEx">Bases: –</div>
            </div>
          </div>
          <div class="foot" id="foot">This image is generated in CI and reflects the latest committed dataset.</div>
        </div>
      </div>

      <div class="col">
        <div class="card" style="flex:1;">
          <div class="smallTitle">Data Pipeline Health</div>
          <div class="row"><div class="lbl">Generated At (UTC)</div><div class="val" id="genAt">–</div></div>
          <div class="sep"></div>
          <div class="row"><div class="lbl">METAR Returned</div><div class="val" id="metarRet">–</div></div>
          <div class="row"><div class="lbl">Missing METAR</div><div class="val" id="metarMiss">–</div></div>
          <div class="sep"></div>
          <div class="row"><div class="lbl">TAF Returned</div><div class="val" id="tafRet">–</div></div>
          <div class="row"><div class="lbl">Missing TAF</div><div class="val" id="tafMiss">–</div></div>
          <div class="sep"></div>
          <div class="row"><div class="lbl">Watchlist Airports</div><div class="val" id="wl">–</div></div>
          <div class="sep"></div>
          <div class="list" id="errBox"><b>Errors:</b> –</div>
        </div>
      </div>
    </div>
  </div>

<script>
(async () => {
  // IMPORTANT: use absolute paths from repo root so the CI local server can serve them reliably
  const STATUS_URL = "/data/status.json";
  const LATEST_URL = "/data/latest.json";
  const BASE_URL   = "/base.txt";

  const el = (id) => document.getElementById(id);

  function uniq(arr){ return Array.from(new Set(arr)); }
  function topN(arr, n){ return arr.slice(0, n); }
  function fmtExamples(list){
    const x = topN(list, 10);
    return x.length ? x.join(", ") : "–";
  }
  function parseBases(txt){
    return uniq(txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean));
  }

  // --- data fetch (with safe fallbacks)
  let status = null, latest = null, bases = [];
  try { status = await (await fetch(STATUS_URL, {cache:"no-store"})).json(); } catch(e){ status = null; }
  try { latest = await (await fetch(LATEST_URL, {cache:"no-store"})).json(); } catch(e){ latest = null; }
  try { const t = await (await fetch(BASE_URL, {cache:"no-store"})).text(); bases = parseBases(t); } catch(e){ bases = []; }

  // status UI
  const genAt = status?.generatedAt || status?.generated_at || status?.generated || "–";
  el("stamp").textContent = `Generated: ${genAt} UTC`;
  el("genAt").textContent = genAt;
  el("metarRet").textContent = String(status?.metarReturned ?? "–");
  el("metarMiss").textContent = String(status?.missingMetar ?? "–");
  el("tafRet").textContent = String(status?.tafReturned ?? "–");
  el("tafMiss").textContent = String(status?.missingTaf ?? "–");

  const errs = Array.isArray(status?.errors) ? status.errors : [];
  el("errBox").innerHTML = `<b>Errors:</b> ${errs.length ? errs.slice(0,6).join(" • ") : "–"}`;

  // stations list (support both shapes: latest.stations or latest array)
  const stations = Array.isArray(latest) ? latest : (latest?.stations || latest?.airports || []);
  el("wl").textContent = String(stations.length || "–");

  // --- classify (best-effort; uses common fields)
  function getIata(s){
    return (s.iata || s.IATA || s.iataCode || s.code || s.icao || s.ICAO || "").toString().trim();
  }
  function sevNow(s){
    return (s.nowSeverity || s.severityNow || s.severity || s.now_severity || "").toString().toLowerCase();
  }
  function sevTaf(s){
    return (s.tafSeverity || s.severityTaf || s.forecastSeverity || s.taf_severity || "").toString().toLowerCase();
  }
  // normalize to crit/high/med
  function normSev(v){
    if (!v) return "";
    if (v.startsWith("crit")) return "crit";
    if (v.startsWith("high")) return "high";
    if (v.startsWith("med")) return "med";
    if (v === "3") return "crit";
    if (v === "2") return "high";
    if (v === "1") return "med";
    return "";
  }

  const nowCrit=[], nowHigh=[], nowMed=[], tafCrit=[], tafHigh=[], tafMed=[];
  const nowBases=[], tafBases=[];
  for (const s of stations) {
    const code = getIata(s);
    if (!code) continue;

    const n = normSev(sevNow(s));
    const t = normSev(sevTaf(s));

    if (n==="crit") nowCrit.push(code);
    else if (n==="high") nowHigh.push(code);
    else if (n==="med") nowMed.push(code);

    if (t==="crit") tafCrit.push(code);
    else if (t==="high") tafHigh.push(code);
    else if (t==="med") tafMed.push(code);

    if (bases.includes(code) && n) nowBases.push(code);
    if (bases.includes(code) && t) tafBases.push(code);
  }

  // Fill now
  el("nowCrit").textContent = String(nowCrit.length);
  el("nowHigh").textContent = String(nowHigh.length);
  el("nowMed").textContent = String(nowMed.length);
  el("nowBases").textContent = String(uniq(nowBases).length);

  el("nowCritEx").textContent = `Examples: ${fmtExamples(uniq(nowCrit))}`;
  el("nowHighEx").textContent = `Examples: ${fmtExamples(uniq(nowHigh))}`;
  el("nowMedEx").textContent = `Examples: ${fmtExamples(uniq(nowMed))}`;
  el("nowBasesEx").textContent = `Bases: ${fmtExamples(uniq(nowBases))}`;

  // Fill taf
  el("tafCrit").textContent = String(tafCrit.length);
  el("tafHigh").textContent = String(tafHigh.length);
  el("tafMed").textContent = String(tafMed.length);
  el("tafBases").textContent = String(uniq(tafBases).length);

  el("tafCritEx").textContent = `Examples: ${fmtExamples(uniq(tafCrit))}`;
  el("tafHighEx").textContent = `Examples: ${fmtExamples(uniq(tafHigh))}`;
  el("tafMedEx").textContent = `Examples: ${fmtExamples(uniq(tafMed))}`;
  el("tafBasesEx").textContent = `Bases: ${fmtExamples(uniq(tafBases))}`;

  // signal ready for CI renderer
  window.__RENDER_READY__ = true;
})();
</script>
</body>
</html>
