<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>WXWI TV Infographic</title>
  <style>
    :root{
      --bg:#02030a;
      --panel:#071026;
      --stroke: rgba(0, 255, 255, 0.42);
      --stroke2: rgba(0, 255, 255, 0.25);
      --txt: rgba(235, 255, 255, 0.95);
      --muted: rgba(180, 220, 220, 0.75);
      --crit: rgba(255, 80, 120, 0.95);
      --high: rgba(255, 210, 80, 0.95);
      --med: rgba(90, 200, 255, 0.95);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{box-sizing:border-box;width:100vw;height:100vh;padding:3vw;display:flex;flex-direction:column;gap:2vw;}
    .hdr{display:flex;justify-content:space-between;align-items:flex-end;gap:2vw;}
    .brand{
      font-weight:900; letter-spacing:0.14em; text-transform:uppercase;
      font-size: clamp(26px, 2.15vw, 78px);
      text-shadow: 0 0 26px rgba(0,255,255,0.18);
    }
    .stamp{
      font-size: clamp(14px, 0.9vw, 28px);
      color: var(--muted);
      text-align:right;
      line-height:1.2;
    }
    .grid{flex:1;display:grid;grid-template-columns:1.2fr 1fr;gap:2vw;min-height:0;}
    .col{display:flex;flex-direction:column;gap:2vw;min-height:0;}
    .card{
      background:linear-gradient(180deg, rgba(7,16,38,0.92), rgba(7,16,38,0.72));
      border:2px solid var(--stroke2);
      border-radius:22px;
      box-shadow: 0 0 0 1px rgba(0,255,255,0.10), 0 0 30px rgba(0,255,255,0.08);
      padding:1.6vw;
      position:relative;
      overflow:hidden;
      min-height:0;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      border:2px solid var(--stroke);
      border-radius:24px;
      filter: drop-shadow(0 0 14px rgba(0,255,255,0.18));
      pointer-events:none;
      opacity:0.45;
    }
    .titleRow{display:flex;align-items:baseline;justify-content:space-between;gap:1.2vw;margin-bottom:1.1vw;}
    .cardTitle{
      font-size: clamp(20px, 1.35vw, 52px);
      font-weight:900; letter-spacing:0.10em; text-transform:uppercase;
      color: rgba(220,255,255,0.98);
    }
    .badge{
      font-size: clamp(12px, 0.85vw, 26px);
      padding:0.35em 0.7em;
      border-radius:999px;
      border:1px solid rgba(0,255,255,0.35);
      color: rgba(210,255,255,0.9);
      background: rgba(0,0,0,0.18);
    }
    .kpis{display:grid;grid-template-columns:repeat(2, 1fr);gap:1.4vw;}
    .kpi{
      background: rgba(0,0,0,0.20);
      border:1px solid rgba(0,255,255,0.18);
      border-radius:18px;
      padding:1.1vw;
      box-shadow: inset 0 0 22px rgba(0,255,255,0.05);
    }
    .kpiName{font-size: clamp(12px, 0.85vw, 26px);color:var(--muted);letter-spacing:0.08em;text-transform:uppercase;}
    .kpiVal{margin-top:0.4vw;font-size: clamp(18px, 1.25vw, 46px);font-weight:900;}
    .kpiVal.crit{color:var(--crit);text-shadow:0 0 14px rgba(255,80,120,0.20);}
    .kpiVal.high{color:var(--high);text-shadow:0 0 14px rgba(255,210,80,0.16);}
    .kpiVal.med{color:var(--med);text-shadow:0 0 14px rgba(90,200,255,0.16);}
    .kpiSub{margin-top:0.35vw;font-size: clamp(12px, 0.75vw, 22px);color:var(--muted);line-height:1.25;}
    .list{margin-top:1.2vw;font-size: clamp(12px, 0.8vw, 24px);color:var(--muted);line-height:1.35;}
    .list b{color:rgba(235,255,255,0.95);}
    .smallTitle{font-size: clamp(18px, 1.2vw, 44px);font-weight:900;letter-spacing:0.10em;text-transform:uppercase;margin-bottom:1vw;}
    .row{display:flex;justify-content:space-between;gap:1vw;align-items:baseline;}
    .row .lbl{color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;font-size: clamp(12px, 0.75vw, 22px);}
    .row .val{font-weight:900;font-size: clamp(16px, 1.05vw, 38px);}
    .sep{height:1px;background:rgba(0,255,255,0.15);margin:0.9vw 0;}
    .foot{color:rgba(150,200,200,0.65);font-size: clamp(10px, 0.7vw, 20px);letter-spacing:0.05em;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <div class="brand">WXWI OPERATIONAL WEATHER - TV BRIEF</div>
      <div class="stamp" id="stamp">Loading…</div>
    </div>

    <div class="grid">
      <div class="col">
        <div class="card">
          <div class="titleRow">
            <div class="cardTitle">Current (METAR)</div>
            <div class="badge">NOW</div>
          </div>
          <div class="kpis">
            <div class="kpi">
              <div class="kpiName">Critical (≥70)</div>
              <div class="kpiVal crit" id="nowCrit">–</div>
              <div class="kpiSub" id="nowCritEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">High (45–69)</div>
              <div class="kpiVal high" id="nowHigh">–</div>
              <div class="kpiSub" id="nowHighEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Medium (20–44)</div>
              <div class="kpiVal med" id="nowMed">–</div>
              <div class="kpiSub" id="nowMedEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Affected Bases</div>
              <div class="kpiVal" id="nowBases">–</div>
              <div class="kpiSub" id="nowBasesEx">Bases: –</div>
            </div>
          </div>
          <div class="list" id="nowNotes">
            <b>Drivers:</b> visibility/RVR, low cloud base, wind/gusts, snow/contamination (from current triggers).
          </div>
        </div>

        <div class="card">
          <div class="titleRow">
            <div class="cardTitle">Forecast (TAF)</div>
            <div class="badge">FORECAST</div>
          </div>
          <div class="kpis">
            <div class="kpi">
              <div class="kpiName">Critical (≥70)</div>
              <div class="kpiVal crit" id="tafCrit">–</div>
              <div class="kpiSub" id="tafCritEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">High (45–69)</div>
              <div class="kpiVal high" id="tafHigh">–</div>
              <div class="kpiSub" id="tafHighEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Medium (20–44)</div>
              <div class="kpiVal med" id="tafMed">–</div>
              <div class="kpiSub" id="tafMedEx">Examples: –</div>
            </div>
            <div class="kpi">
              <div class="kpiName">Affected Bases</div>
              <div class="kpiVal" id="tafBases">–</div>
              <div class="kpiSub" id="tafBasesEx">Bases: –</div>
            </div>
          </div>
          <div class="foot">This image is generated in CI and reflects the latest committed dataset.</div>
        </div>
      </div>

      <div class="col">
        <div class="card" style="flex:1;">
          <div class="smallTitle">Data Pipeline Health</div>
          <div class="row"><div class="lbl">Generated At (UTC)</div><div class="val" id="genAt">–</div></div>
          <div class="sep"></div>
          <div class="row"><div class="lbl">METAR Returned</div><div class="val" id="metarRet">–</div></div>
          <div class="row"><div class="lbl">Missing METAR</div><div class="val" id="metarMiss">–</div></div>
          <div class="sep"></div>
          <div class="row"><div class="lbl">TAF Returned</div><div class="val" id="tafRet">–</div></div>
          <div class="row"><div class="lbl">Missing TAF</div><div class="val" id="tafMiss">–</div></div>
          <div class="sep"></div>
          <div class="row"><div class="lbl">Watchlist Airports</div><div class="val" id="wl">–</div></div>
          <div class="sep"></div>
          <div class="list" id="errBox"><b>Errors:</b> –</div>
        </div>
      </div>
    </div>
  </div>

<script>
(async () => {
  // Use absolute paths from repo root: works for GitHub Pages and the CI local server
  const STATUS_URL = "/data/status.json";
  const LATEST_URL = "/data/latest.json";
  const BASE_URL   = "/base.txt";

  const el = (id) => document.getElementById(id);

  function uniq(arr){ return Array.from(new Set(arr)); }
  function topN(arr, n){ return arr.slice(0, n); }
  function fmtExamples(list){
    const x = topN(list, 10);
    return x.length ? x.join(", ") : "–";
  }
  function parseBases(txt){
    return uniq(txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean));
  }

  function alertFromScore(score){
    const s = Number(score || 0);
    return s >= 70 ? "CRIT" : s >= 45 ? "HIGH" : s >= 20 ? "MED" : "OK";
  }

  // data fetch (safe)
  let status = null, latest = null, bases = [];
  try { status = await (await fetch(STATUS_URL, {cache:"no-store"})).json(); } catch(e){ status = null; }
  try { latest  = await (await fetch(LATEST_URL,  {cache:"no-store"})).json(); } catch(e){ latest  = null; }
  try { const t = await (await fetch(BASE_URL,   {cache:"no-store"})).text(); bases = parseBases(t); } catch(e){ bases = []; }

  // status UI: note -> stats live under status.stats
  const genAt = status?.generatedAt || latest?.generatedAt || "–";
  el("stamp").textContent = `Generated: ${genAt} UTC`;
  el("genAt").textContent = genAt;

  const st = status?.stats || latest?.stats || {};
  el("metarRet").textContent  = String(st.metarReturned ?? "–");
  el("metarMiss").textContent = String(st.missingMetar ?? "–");
  el("tafRet").textContent    = String(st.tafReturned ?? "–");
  el("tafMiss").textContent   = String(st.missingTaf ?? "–");

  const errs = Array.isArray(status?.errors) ? status.errors : (Array.isArray(latest?.errors) ? latest.errors : []);
  el("errBox").innerHTML = `<b>Errors:</b> ${errs.length ? errs.slice(0,6).join(" • ") : "–"}`;

  // stations list
  const stations = Array.isArray(latest?.stations) ? latest.stations : (Array.isArray(latest) ? latest : []);
  el("wl").textContent = String(stations.length || "–");

  // classify using metPri/tafPri (the repo's canonical severity scores)
  const nowCrit=[], nowHigh=[], nowMed=[], tafCrit=[], tafHigh=[], tafMed=[];
  const nowBases=[], tafBases=[];

  // Build sorted lists by priority
  const byMet = stations
    .map(s => ({ code: (s.iata||s.icao||"").toString().trim(), pri: Number(s.metPri||0) }))
    .filter(x => x.code)
    .sort((a,b)=>b.pri-a.pri);

  const byTaf = stations
    .map(s => ({ code: (s.iata||s.icao||"").toString().trim(), pri: Number(s.tafPri||0) }))
    .filter(x => x.code)
    .sort((a,b)=>b.pri-a.pri);

  // quick lookup for base membership
  const baseSet = new Set(bases);

  for (const s of stations) {
    const code = (s.iata||s.icao||"").toString().trim();
    if (!code) continue;

    const nA = alertFromScore(s.metPri);
    const tA = alertFromScore(s.tafPri);

    if (nA==="CRIT") nowCrit.push(code);
    else if (nA==="HIGH") nowHigh.push(code);
    else if (nA==="MED") nowMed.push(code);

    if (tA==="CRIT") tafCrit.push(code);
    else if (tA==="HIGH") tafHigh.push(code);
    else if (tA==="MED") tafMed.push(code);

    if (baseSet.has(code) && nA!=="OK") nowBases.push(code);
    if (baseSet.has(code) && tA!=="OK") tafBases.push(code);
  }

  // Examples: prefer highest priority airports
  function examplesFromSorted(sorted, wantedAlert){
    const out=[];
    for (const x of sorted){
      const a = alertFromScore(x.pri);
      if (a===wantedAlert) out.push(x.code);
      if (out.length>=10) break;
    }
    return out;
  }

  // Fill now
  el("nowCrit").textContent = String(nowCrit.length);
  el("nowHigh").textContent = String(nowHigh.length);
  el("nowMed").textContent = String(nowMed.length);
  el("nowBases").textContent = String(uniq(nowBases).length);

  el("nowCritEx").textContent = `Examples: ${fmtExamples(examplesFromSorted(byMet,"CRIT"))}`;
  el("nowHighEx").textContent = `Examples: ${fmtExamples(examplesFromSorted(byMet,"HIGH"))}`;
  el("nowMedEx").textContent  = `Examples: ${fmtExamples(examplesFromSorted(byMet,"MED"))}`;
  el("nowBasesEx").textContent = `Bases: ${fmtExamples(uniq(nowBases).sort())}`;

  // Fill taf
  el("tafCrit").textContent = String(tafCrit.length);
  el("tafHigh").textContent = String(tafHigh.length);
  el("tafMed").textContent = String(tafMed.length);
  el("tafBases").textContent = String(uniq(tafBases).length);

  el("tafCritEx").textContent = `Examples: ${fmtExamples(examplesFromSorted(byTaf,"CRIT"))}`;
  el("tafHighEx").textContent = `Examples: ${fmtExamples(examplesFromSorted(byTaf,"HIGH"))}`;
  el("tafMedEx").textContent  = `Examples: ${fmtExamples(examplesFromSorted(byTaf,"MED"))}`;
  el("tafBasesEx").textContent = `Bases: ${fmtExamples(uniq(tafBases).sort())}`;

  // signal ready for CI renderer
  window.__RENDER_READY__ = true;
})();
</script>
</body>
</html>
