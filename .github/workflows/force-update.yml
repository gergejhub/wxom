name: Force Dataset Refresh (30m)

on:
  schedule:
    # Extra safety net: runs every 30 minutes, even if the 5-min workflow is delayed or disabled.
    # Using offset minutes to reduce collisions with the */5 schedule.
    - cron: "2,32 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: dataset
  cancel-in-progress: true

jobs:
  force_update:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (puppeteer)
        run: npm install --no-audit --no-fund

      - name: Force update data (3 retries)
        run: |
          set -e
          for i in 1 2 3; do
            echo "[FORCE] Update attempt $i/3"
            if node scripts/update-data.mjs; then
              echo "[FORCE] Update succeeded."
              break
            fi
            echo "[FORCE] Update failed, sleeping 20s..."
            sleep 20
          done

      - name: Render TV infographic (4K + 1080p)
        run: node scripts/render-infographic.mjs

      - name: Write force heartbeat
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const out = path.join('data','force_heartbeat.json');
          const payload = { generatedAt: new Date().toISOString(), note: "force-update.yml heartbeat" };
          fs.writeFileSync(out, JSON.stringify(payload, null, 2));
          console.log('Wrote', out);
          NODE

      - name: Commit & push (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add data/latest.json data/status.json data/runways.json data/iata_map.json data/schema_debug.json data/management_brief.json data/changes.json data/force_heartbeat.json
            git add assets/render/wxwi-dashboard-4k.webp assets/render/wxwi-dashboard-1080p.webp
            git commit -m "Force refresh dataset + TV infographic"
            git push
          else
            echo "No changes to commit."
          fi
